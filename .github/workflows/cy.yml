name: Run Cypress Tests

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Selecione o tipo de teste a ser executado'
        required: true
        default: 'api'
        type: choice
        options:
          - api
          - e2e

jobs:
  setup-environment:
    uses: ./.github/workflows/setup-workflow.yml  # Chamando o workflow de setup

  run-tests:
    runs-on: ubuntu-latest
    needs: setup-environment  # Garante que o setup seja concluído antes de rodar os testes
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2  # Checkout do código

      - name: Run Cypress Tests
        run: |
          if [ "${{ github.event.inputs.test_type }}" == "api" ]; then
            npm run cy-api:run  # Comando para rodar testes API
          else
            npm run cy-e2e:run  # Comando para rodar testes E2E
          fi

  generate-report:
    needs: run-tests  # Só executa após os testes serem executados
    runs-on: ubuntu-latest
    steps:
      - name: Generate Allure Report
        run: |
          allure generate allure-results --clean -o allure-report  # Gerar relatório Allure
          allure open allure-report  # Abrir o relatório no navegador
